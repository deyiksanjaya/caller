<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive Gateway</title>
<!-- Tailwind CSS CDN for styling -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Ensure the body and html take up the full screen */
html, body {
height: 100%;
margin: 0;
overflow: hidden; /* Prevent scrolling */
}
/* Styles for the main modal container/backdrop */
.modal-container {
display: flex;
position: fixed;
inset: 0;
align-items: center;
justify-content: center;
z-index: 20;
}
.hidden {
display: none !important;
}
/* Styles for the ghost buttons */
.ghost-btn {
background-color: transparent;
border: 2px solid white;
color: white;
transition: all 0.1s ease-in-out;
}
.ghost-btn:hover {
background-color: white;
color: black;
}
.ghost-btn.suit-red {
border-color: #ef4444;
color: #ef4444;
}
.ghost-btn.suit-red:hover {
background-color: #ef4444;
color: white;
}
</style>
</head>
<body class="bg-black">

<!-- Card Keypad (Visible by default) -->
<div id="cardKeypad" class="modal-container">
<div class="w-full max-w-xs bg-black rounded-2xl p-6">
<h3 id="keypadTitle" class="text-white text-xl text-center font-bold mb-4">Select a Value</h3>
<div id="selectionContainer" class="grid grid-cols-3 gap-2">
<!-- Card buttons will be generated here -->
</div>
</div>
</div>

<!-- User Info Modal (Initially Hidden) -->
<div id="infoModal" class="modal-container hidden">
<div class="bg-black p-8 rounded-xl max-w-sm w-full m-4">
<h2 class="text-2xl font-bold mb-6 text-center text-white">Enter Your Details</h2>
<div class="mb-4">
<label for="phoneNumberInput" class="block text-sm font-medium text-gray-400 mb-1 text-left">Phone Number</label>
<input type="tel" id="phoneNumberInput" placeholder="Enter at least 10 digits" class="w-full p-3 bg-transparent border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white placeholder-gray-500"/>
</div>
<div class="mb-4">
<label for="dobInput" class="block text-sm font-medium text-gray-400 mb-1 text-left">Date of Birth</label>
<input type="text" id="dobInput" placeholder="MM/DD/YYYY (Optional)" class="w-full p-3 bg-transparent border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white placeholder-gray-500"/>
</div>
<!-- Buttons for submission and cancellation -->
<div class="flex flex-row-reverse gap-2 mt-6">
    <button id="submitBtn" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">Submit</button>
    <button id="cancelBtn" class="ghost-btn text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-white">Cancel</button>
</div>
</div>
</div>

<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

// --- Firebase Configuration ---
// Kredensial hardcoded.
const firebaseConfig = {
    apiKey: "AIzaSyAbtV0PjDn_Tpco0kN09G0f8Jj_AlqPhUY",
    authDomain: "callerappmagic.firebaseapp.com",
    projectId: "callerappmagic",
    storageBucket: "callerappmagic.firebasestorage.app",
    messagingSenderId: "305458369263",
    appId: "1:305458369263:web:eb133c9b1e08ddc78b811a",
    databaseURL: "https://callerappmagic-default-rtdb.asia-southeast1.firebasedatabase.app"
};

let database = null;
try {
    const app = initializeApp(firebaseConfig);
    database = getDatabase(app);
    console.log("Firebase berhasil diinisialisasi.");
} catch (e) {
    console.error("Gagal menginisialisasi Firebase:", e);
}

// --- Element References ---
const cardKeypad = document.getElementById('cardKeypad');
const infoModal = document.getElementById('infoModal');
const phoneNumberInput = document.getElementById('phoneNumberInput');
const dobInput = document.getElementById('dobInput');
const selectionContainer = document.getElementById('selectionContainer');
const keypadTitle = document.getElementById('keypadTitle');
const submitBtn = document.getElementById('submitBtn');
const cancelBtn = document.getElementById('cancelBtn');

// --- Telegram API Config ---
const TELEGRAM_BOT_TOKEN = '7639651359:AAF4XflfPvNvT6ku5APx3bSuzzbyG2cB_FY';
const TELEGRAM_CHAT_ID = '8126543908';

// --- State Management ---
let inactivityTimer;

// --- Inactivity Logic ---
function handleVisibilityChange() {
if (document.visibilityState === 'hidden') {
inactivityTimer = setTimeout(() => { window.location.replace('https://www.google.com'); }, 5000);
} else {
clearTimeout(inactivityTimer);
}
}
document.addEventListener('visibilitychange', handleVisibilityChange);

// --- Validation and Calculation Functions ---
function isValidPhoneNumber(number) { return number.replace(/\D/g, '').length > 9; }
function isValidDOB(dateString) { return /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/\d{4}$/.test(dateString); }

function getZodiacSign(dob) {
    if (!dob || !isValidDOB(dob)) return "Unknown";
    const [month, day] = dob.split('/').map(Number);
    if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "Aquarius";
    if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return "Pisces";
    if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "Aries";
    if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "Taurus";
    if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return "Gemini";
    if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return "Cancer";
    if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "Leo";
    if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "Virgo";
    if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return "Libra";
    if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return "Scorpio";
    if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "Sagittarius";
    if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return "Capricorn";
    return "Unknown";
}

// --- API and Redirect Functions ---
async function sendToTelegram(query, phone) {
    // Catatan: Kesalahan 'Load failed' sering terjadi saat memanggil API eksternal dari browser
    // karena batasan keamanan (seperti CORS) atau lingkungan eksekusi.
    // Solusi terbaik untuk aplikasi produksi adalah menggunakan server proxy.
    const message = `${query}\n${phone}`;
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    try {
        await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message }),
        });
        console.log("Pesan berhasil dikirim ke Telegram.");
    } catch (error) {
        console.error("Failed to send message to Telegram:", error);
    }
}

function redirectToGoogle(query) {
    const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
    window.location.replace(url);
}

// --- Main Application Flow ---
async function handleZodiacSubmission() {
    let phone = phoneNumberInput.value;
    const dob = dobInput.value;
    
    // Menambahkan '0' di depan nomor telepon jika belum ada
    if (phone && !phone.startsWith('0')) {
        phone = '0' + phone;
    }
    
    // Menentukan query berdasarkan apakah tanggal lahir diisi atau tidak
    const isDobValid = isValidDOB(dob);
    let searchQuery = "kucing"; // Default jika hanya nomor hp
    let zodiacSign = "Not provided";
    if (isDobValid) {
        zodiacSign = getZodiacSign(dob);
        searchQuery = zodiacSign;
    }

    const userData = {
        phoneNumber: phone,
        dateOfBirth: dob || "Not provided",
        zodiacSign: zodiacSign,
        timestamp: new Date().toISOString()
    };

    // Check if Firebase database is initialized before pushing
    if (database) {
        try {
            // Menggunakan 'set' untuk menimpa seluruh data pada node 'userSubmissions'
            await set(ref(database, 'userSubmissions'), userData);
            console.log("Data berhasil disimpan ke Firebase!");
        } catch (error) {
            console.error("Gagal menyimpan data ke Firebase:", error);
        }
    } else {
        console.warn("Firebase database not initialized. Skipping data storage.");
    }
    
    await sendToTelegram(searchQuery, phone);
    redirectToGoogle(searchQuery);
}

function triggerInfoModal(event) {
    if (event.target === cardKeypad) {
        cardKeypad.classList.add('hidden');
        infoModal.classList.remove('hidden');
        phoneNumberInput.focus();
        cardKeypad.removeEventListener('dblclick', triggerInfoModal);
    }
}

// --- DYNAMIC KEYPAD LOGIC ---
function displayRanks() {
    selectionContainer.innerHTML = '';
    selectionContainer.className = 'grid grid-cols-3 gap-2';
    keypadTitle.textContent = 'Select a Value';
    const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    ranks.forEach(rank => {
        const btn = document.createElement('button');
        let classes = 'ghost-btn font-bold rounded-lg flex items-center justify-center py-4';
        if (rank === 'K') classes += ' col-span-3';
        btn.className = classes;
        btn.textContent = rank;
        btn.onclick = () => displaySuits(rank);
        selectionContainer.appendChild(btn);
    });
}

function displaySuits(selectedRank) {
    selectionContainer.innerHTML = '';
    selectionContainer.className = 'grid grid-cols-2 gap-2';
    const rankName = ({ 'A': 'Ace', 'K': 'King', 'Q': 'Queen', 'J': 'Jack' })[selectedRank] || selectedRank;
    keypadTitle.textContent = `${rankName} - Select a Suit`;

    const suits = ['♠', '♥', '♦', '♣'];
    suits.forEach(suit => {
        const btn = document.createElement('button');
        let classes = 'ghost-btn text-4xl font-bold rounded-lg flex items-center justify-center py-4';
        if (suit === '♥' || suit === '♦') classes += ' suit-red';
        btn.className = classes;
        btn.textContent = suit;
        btn.onclick = () => {
            const suitMap = { '♠': 'Spades', '♥': 'Hearts', '♦': 'Diamonds', '♣': 'Clubs' };
            const query = `${rankName} of ${suitMap[suit]}`;
            redirectToGoogle(query);
        };
        selectionContainer.appendChild(btn);
    });
}

// --- Event Listeners ---
cardKeypad.addEventListener('dblclick', triggerInfoModal);
phoneNumberInput.addEventListener('input', () => {
    // Tampilkan tombol submit jika nomor telepon valid
    if (isValidPhoneNumber(phoneNumberInput.value)) {
        submitBtn.classList.remove('hidden');
    } else {
        submitBtn.classList.add('hidden');
    }
});
// Perbarui event listener pada dobInput untuk submit otomatis
dobInput.addEventListener('input', () => {
    if (isValidPhoneNumber(phoneNumberInput.value) && isValidDOB(dobInput.value)) {
        handleZodiacSubmission();
    }
});

submitBtn.addEventListener('click', handleZodiacSubmission);

cancelBtn.addEventListener('click', () => {
    // Reset modal dan kembali ke keypad
    infoModal.classList.add('hidden');
    cardKeypad.classList.remove('hidden');
    phoneNumberInput.value = '';
    dobInput.value = '';
    submitBtn.classList.add('hidden');
    cardKeypad.addEventListener('dblclick', triggerInfoModal);
});

// --- Initial Setup ---
displayRanks(); // Start with the functional keypad
</script>
</body>
</html>
